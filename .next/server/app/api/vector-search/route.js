"use strict";(()=>{var e={};e.id=656,e.ids=[656],e.modules={8775:e=>{e.exports=require("@langchain/openai")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},6987:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>y,originalPathname:()=>x,patchFetch:()=>_,requestAsyncStorage:()=>p,routeModule:()=>d,serverHooks:()=>f,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>E});var o={};t.r(o),t.d(o,{GET:()=>m,POST:()=>h,dynamic:()=>u,runtime:()=>l});var n=t(5419),a=t(9108),s=t(9678),i=t(8070),c=t(7399);let l="nodejs",u="force-dynamic";async function h(e){try{let{query:r,limit:t=10,threshold:o=.7}=await e.json();if(!r||"string"!=typeof r)return i.Z.json({error:"검색 쿼리가 필요합니다."},{status:400});console.log("벡터 검색 요청:",{query:r,limit:t,threshold:o});let n=await (0,c.eB)(r),a=await (0,c.yD)(n,t,o);return i.Z.json({success:!0,query:r,results:a.map(e=>({text:e.chunk_text,metadata:e.metadata,similarity:e.similarity})),totalResults:a.length})}catch(e){return console.error("벡터 검색 오류:",e),i.Z.json({error:`벡터 검색에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`},{status:500})}}async function m(){try{return i.Z.json({success:!0,message:"벡터 검색 API가 정상적으로 작동합니다.",features:["의미적 유사도 검색","코사인 유사도 기반 랭킹","임계값 필터링","메타데이터 포함"]})}catch(e){return console.error("벡터 검색 상태 확인 오류:",e),i.Z.json({error:"벡터 검색 상태를 확인할 수 없습니다."},{status:500})}}let d=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/vector-search/route",pathname:"/api/vector-search",filename:"route",bundlePath:"app/api/vector-search/route"},resolvedPagePath:"C:\\Users\\김민제\\Documents\\Dev\\aieewa\\app\\api\\vector-search\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:p,staticGenerationAsyncStorage:g,serverHooks:f,headerHooks:y,staticGenerationBailout:E}=d,x="/api/vector-search/route";function _(){return(0,s.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:g})}},7399:(e,r,t)=>{t.d(r,{Hy:()=>u,eB:()=>c,yD:()=>l});var o=t(8775),n=t(8234);let a=null;function s(){if(!a){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY 환경 변수가 설정되지 않았습니다.");a=new o.OpenAIEmbeddings({openAIApiKey:process.env.OPENAI_API_KEY,modelName:"text-embedding-3-small",batchSize:100})}return a}async function i(e){try{console.log(`${e.length}개 텍스트에 대한 임베딩 생성 시작`);let r=s(),t=await r.embedDocuments(e);return console.log(`임베딩 생성 완료: ${t.length}개 벡터`),t}catch(e){throw console.error("임베딩 생성 오류:",e),Error(`임베딩 생성에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`)}}async function c(e){try{let r=s();return await r.embedQuery(e)}catch(e){throw console.error("단일 임베딩 생성 오류:",e),Error(`임베딩 생성에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`)}}async function l(e,r=10,t=.7){try{let o=(0,n.B$)(),{data:a,error:s}=await o.from("document_chunks").select("chunk_text, metadata, embedding").not("embedding","is",null);if(s)return console.error("청크 조회 오류:",s),[];if(!a||0===a.length)return console.log("임베딩된 청크가 없습니다."),[];let i=a.map(r=>{if(!r.embedding||!Array.isArray(r.embedding))return{...r,similarity:0};let t=function(e,r){if(e.length!==r.length)throw Error("벡터 차원이 일치하지 않습니다.");let t=0,o=0,n=0;for(let a=0;a<e.length;a++)t+=e[a]*r[a],o+=e[a]*e[a],n+=r[a]*r[a];return 0===o||0===n?0:t/(Math.sqrt(o)*Math.sqrt(n))}(e,r.embedding);return{...r,similarity:t}}).filter(e=>e.similarity>=t).sort((e,r)=>r.similarity-e.similarity).slice(0,r);return console.log(`벡터 검색 결과: ${i.length}개 (임계값: ${t})`),i}catch(e){return console.error("벡터 검색 오류:",e),[]}}async function u(e,r){try{let t=(0,n.B$)(),o=Math.ceil(e.length/50);console.log(`${e.length}개 청크를 ${o}개 배치로 처리`);for(let n=0;n<e.length;n+=50){let a=e.slice(n,n+50),s=Math.floor(n/50)+1;console.log(`배치 ${s}/${o} 처리 중... (${a.length}개 청크)`);try{let e=a.map(e=>e.text),n=await i(e),c=a.map((e,t)=>({document_id:r,chunk_text:e.text,chunk_index:e.chunkIndex,metadata:e.metadata,embedding:n[t]})),{error:l}=await t.from("document_chunks").insert(c);l?console.error(`배치 ${s} 저장 오류:`,l):console.log(`배치 ${s} 저장 완료`),s<o&&await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`배치 ${s} 처리 오류:`,e)}}console.log("모든 청크 임베딩 처리 완료")}catch(e){throw console.error("청크 임베딩 처리 오류:",e),e}}},8234:(e,r,t)=>{t.d(r,{B$:()=>n});var o=t(7385);function n(){let e="https://puajxghokhribumtxrby.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!r){let t=[];throw e||t.push("NEXT_PUBLIC_SUPABASE_URL"),r||t.push("SUPABASE_SERVICE_ROLE_KEY"),Error(`Missing Supabase environment variables: ${t.join(", ")}`)}return(0,o.eI)(e,r)}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[638,117],()=>t(6987));module.exports=o})();