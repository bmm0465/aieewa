"use strict";(()=>{var e={};e.id=892,e.ids=[892],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},9751:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>P,originalPathname:()=>S,patchFetch:()=>q,requestAsyncStorage:()=>x,routeModule:()=>$,serverHooks:()=>w,staticGenerationAsyncStorage:()=>k,staticGenerationBailout:()=>E});var s={};r.r(s),r.d(s,{GET:()=>_,POST:()=>g,dynamic:()=>h,maxDuration:()=>m,runtime:()=>f});var n=r(5419),o=r(9108),a=r(9678),i=r(8070),l=r(3292),u=r(1017),c=r(7147),d=r(8234);let p=r(8051),f="nodejs",m=300,h="force-dynamic";async function g(e){try{console.log("기본 PDF 전처리 시작");let t=(0,u.join)(process.cwd(),"pdf");if(!(0,c.existsSync)(t))return i.Z.json({error:"pdf 폴더를 찾을 수 없습니다."},{status:404});let r=(await (0,l.readdir)(t)).filter(e=>e.toLowerCase().endsWith(".pdf"));if(0===r.length)return i.Z.json({error:"pdf 폴더에 PDF 파일이 없습니다."},{status:404});console.log(`발견된 PDF 파일: ${r.length}개`,r);let s=(0,d.B$)(),n="true"===e.nextUrl.searchParams.get("force");if(n){console.log("기존 기본 문서들 정리 중..."),await s.from("document_chunks").delete().like("metadata->>source","pdf/%");let{data:e}=await s.from("documents").select("id").like("filename","pdf/%");if(e&&e.length>0){let t=e.map(e=>e.id);await s.from("documents").delete().in("id",t)}}let o=[];for(let e of r)try{console.log(`처리 중: ${e}`);let r=(0,u.join)(t,e),a=await (0,l.readFile)(r),i=(await p(a)).text;if(!i||0===i.trim().length){console.warn(`${e}: 텍스트를 추출할 수 없습니다.`),o.push({filename:e,status:"failed",reason:"텍스트 추출 불가"});continue}let c=function(e,t=1e3,r=200){let s=[],n=0;for(;n<e.length;){let o=Math.min(n+t,e.length),a=e.slice(n,o);if(o<e.length){let e=a.lastIndexOf("."),r=Math.max(e,a.lastIndexOf("\n"));r>n+.5*t&&(a=a.slice(0,r+1))}if(s.push(a.trim()),(n+=a.length-r)>=e.length)break;a.length<=r&&(n+=t)}return s.filter(e=>e.length>0)}(i,1e3,200);console.log(`${e}: ${c.length}개 청크 생성`);let{data:d}=await s.from("documents").select("id").eq("filename",`pdf/${e}`).single();if(d&&!n){console.log(`${e}: 이미 처리된 파일입니다. 건너뜀`),o.push({filename:e,status:"skipped",reason:"이미 처리됨"});continue}let{data:f,error:m}=await s.from("documents").upsert({filename:`pdf/${e}`,file_size:a.length,text_content:i.substring(0,1e4),chunk_count:c.length,upload_time:new Date().toISOString()},{onConflict:"filename"}).select().single();if(m){console.error(`${e} 문서 저장 오류:`,m),o.push({filename:e,status:"failed",reason:`문서 저장 실패: ${m.message}`});continue}console.log(`${e} 문서 저장 완료:`,f.id),(d||n)&&await s.from("document_chunks").delete().eq("document_id",f.id);let h=c.map((t,r)=>({document_id:f.id,chunk_text:t,chunk_index:r,metadata:{source:`pdf/${e}`,chunkIndex:r,uploadTime:new Date().toISOString(),isDefault:!0}}));for(let t=0;t<h.length;t+=50){let r=h.slice(t,t+50),{error:n}=await s.from("document_chunks").insert(r);n&&console.error(`${e} 청크 ${t}-${t+50} 저장 오류:`,n)}console.log(`${e}: ${c.length}개 청크 저장 완료`),o.push({filename:e,status:"success",chunks:c.length,textLength:i.length})}catch(t){console.error(`${e} 처리 오류:`,t),o.push({filename:e,status:"failed",reason:t instanceof Error?t.message:"알 수 없는 오류"})}let a=o.filter(e=>"success"===e.status).length,f=o.filter(e=>"failed"===e.status).length,m=o.filter(e=>"skipped"===e.status).length;return i.Z.json({success:!0,message:`PDF 전처리 완료: 성공 ${a}개, 실패 ${f}개, 건너뜀 ${m}개`,totalFiles:r.length,results:o,summary:{success:a,failed:f,skipped:m}})}catch(e){return console.error("PDF 전처리 전체 오류:",e),i.Z.json({error:`PDF 전처리에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`},{status:500})}}async function _(){try{let e=(0,d.B$)(),{data:t,error:r}=await e.from("documents").select("id, filename, file_size, chunk_count, upload_time").like("filename","pdf/%").order("upload_time",{ascending:!1});if(r)return i.Z.json({error:`문서 조회 실패: ${r.message}`},{status:500});let{data:s}=await e.from("document_chunks").select("document_id").in("document_id",t?.map(e=>e.id)||[]),n=s?.length||0;return i.Z.json({success:!0,documents:t||[],totalDocuments:t?.length||0,totalChunks:n})}catch(e){return console.error("PDF 상태 조회 오류:",e),i.Z.json({error:`상태 조회 실패: ${e instanceof Error?e.message:"알 수 없는 오류"}`},{status:500})}}let $=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/preprocess-pdfs/route",pathname:"/api/preprocess-pdfs",filename:"route",bundlePath:"app/api/preprocess-pdfs/route"},resolvedPagePath:"C:\\Users\\bmm04\\Dev\\aieewa\\app\\api\\preprocess-pdfs\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:x,staticGenerationAsyncStorage:k,serverHooks:w,headerHooks:P,staticGenerationBailout:E}=$,S="/api/preprocess-pdfs/route";function q(){return(0,a.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:k})}},8234:(e,t,r)=>{r.d(t,{B$:()=>n});var s=r(7385);function n(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t){let r=[];throw e||r.push("NEXT_PUBLIC_SUPABASE_URL"),t||r.push("SUPABASE_SERVICE_ROLE_KEY"),Error(`Missing Supabase environment variables: ${r.join(", ")}`)}return(0,s.eI)(e,t)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[638,117,51],()=>r(9751));module.exports=s})();