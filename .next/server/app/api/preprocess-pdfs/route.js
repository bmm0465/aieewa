"use strict";(()=>{var e={};e.id=892,e.ids=[892],e.modules={8775:e=>{e.exports=require("@langchain/openai")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},6083:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>k,originalPathname:()=>b,patchFetch:()=>A,requestAsyncStorage:()=>_,routeModule:()=>x,serverHooks:()=>E,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>P});var o={};r.r(o),r.d(o,{GET:()=>w,POST:()=>$,dynamic:()=>g,maxDuration:()=>h,runtime:()=>f});var s=r(5419),n=r(9108),a=r(9678),i=r(8070),l=r(3292),c=r(1017),u=r(7147),d=r(8234),p=r(7399);let m=r(8051),f="nodejs",h=300,g="force-dynamic";async function $(e){try{console.log("기본 PDF 전처리 시작");let t="1"===process.env.VERCEL;console.log("환경 정보:",{isProduction:!0,isVercel:t});let r="",o=[(0,c.join)(process.cwd(),"public","pdf"),(0,c.join)(process.cwd(),"pdf"),(0,c.join)(process.cwd(),"..","pdf")];for(let e of o)if((0,u.existsSync)(e)&&(await (0,l.readdir)(e)).filter(e=>e.toLowerCase().endsWith(".pdf")).length>0){r=e;break}if(!r)return console.log("PDF 폴더를 찾을 수 없습니다. 가능한 경로들:",o),i.Z.json({success:!0,message:"프로덕션 환경에서는 기본 문서들이 이미 준비되어 있습니다.",totalFiles:0,results:[],summary:{success:0,failed:0,skipped:0}});let s=(await (0,l.readdir)(r)).filter(e=>e.toLowerCase().endsWith(".pdf"));console.log(`발견된 PDF 파일: ${s.length}개`,s);let n=(0,d.B$)(),a="true"===e.nextUrl.searchParams.get("force");if(a){console.log("기존 기본 문서들 정리 중..."),await n.from("document_chunks").delete().like("metadata->>source","pdf/%");let{data:e}=await n.from("documents").select("id").like("filename","pdf/%");if(e&&e.length>0){let t=e.map(e=>e.id);await n.from("documents").delete().in("id",t)}}let f=[];for(let e of s)try{console.log(`처리 중: ${e}`);let t=(0,c.join)(r,e),o=await (0,l.readFile)(t),s=(await m(o)).text;if(!s||0===s.trim().length){console.warn(`${e}: 텍스트를 추출할 수 없습니다.`),f.push({filename:e,status:"failed",reason:"텍스트 추출 불가"});continue}let i=function(e,t=1e3,r=200){let o=[],s=0;for(;s<e.length;){let n=Math.min(s+t,e.length),a=e.slice(s,n);if(n<e.length){let e=a.lastIndexOf("."),r=Math.max(e,a.lastIndexOf("\n"));r>s+.5*t&&(a=a.slice(0,r+1))}if(o.push(a.trim()),(s+=a.length-r)>=e.length)break;a.length<=r&&(s+=t)}return o.filter(e=>e.length>0)}(s,1e3,200);console.log(`${e}: ${i.length}개 청크 생성`);let{data:u}=await n.from("documents").select("id").eq("filename",`pdf/${e}`).single();if(u&&!a){console.log(`${e}: 이미 처리된 파일입니다. 건너뜀`),f.push({filename:e,status:"skipped",reason:"이미 처리됨"});continue}let{data:d,error:h}=await n.from("documents").upsert({filename:`pdf/${e}`,file_size:o.length,text_content:s.substring(0,1e4),chunk_count:i.length,upload_time:new Date().toISOString()},{onConflict:"filename"}).select().single();if(h){console.error(`${e} 문서 저장 오류:`,h),f.push({filename:e,status:"failed",reason:`문서 저장 실패: ${h.message}`});continue}console.log(`${e} 문서 저장 완료:`,d.id),(u||a)&&await n.from("document_chunks").delete().eq("document_id",d.id);let g=i.map((t,r)=>({text:t,metadata:{source:`pdf/${e}`,chunkIndex:r,uploadTime:new Date().toISOString(),isDefault:!0},chunkIndex:r}));await (0,p.Hy)(g,d.id),console.log(`${e}: ${i.length}개 청크 벡터 임베딩 저장 완료`),f.push({filename:e,status:"success",chunks:i.length,textLength:s.length})}catch(t){console.error(`${e} 처리 오류:`,t),f.push({filename:e,status:"failed",reason:t instanceof Error?t.message:"알 수 없는 오류"})}let h=f.filter(e=>"success"===e.status).length,g=f.filter(e=>"failed"===e.status).length,$=f.filter(e=>"skipped"===e.status).length;return i.Z.json({success:!0,message:`PDF 전처리 완료: 성공 ${h}개, 실패 ${g}개, 건너뜀 ${$}개`,totalFiles:s.length,results:f,summary:{success:h,failed:g,skipped:$}})}catch(e){return console.error("PDF 전처리 전체 오류:",e),i.Z.json({error:`PDF 전처리에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`},{status:500})}}async function w(){try{let e=(0,d.B$)(),{data:t,error:r}=await e.from("documents").select("id, filename, file_size, chunk_count, upload_time").like("filename","pdf/%").order("upload_time",{ascending:!1});if(r)return i.Z.json({error:`문서 조회 실패: ${r.message}`},{status:500});let{data:o}=await e.from("document_chunks").select("document_id").in("document_id",t?.map(e=>e.id)||[]),s=o?.length||0;return i.Z.json({success:!0,documents:t||[],totalDocuments:t?.length||0,totalChunks:s})}catch(e){return console.error("PDF 상태 조회 오류:",e),i.Z.json({error:`상태 조회 실패: ${e instanceof Error?e.message:"알 수 없는 오류"}`},{status:500})}}let x=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/preprocess-pdfs/route",pathname:"/api/preprocess-pdfs",filename:"route",bundlePath:"app/api/preprocess-pdfs/route"},resolvedPagePath:"C:\\Users\\김민제\\Documents\\Dev\\aieewa\\app\\api\\preprocess-pdfs\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:y,serverHooks:E,headerHooks:k,staticGenerationBailout:P}=x,b="/api/preprocess-pdfs/route";function A(){return(0,a.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:y})}},7399:(e,t,r)=>{r.d(t,{Hy:()=>u,eB:()=>l,yD:()=>c});var o=r(8775),s=r(8234);let n=null;function a(){if(!n){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY 환경 변수가 설정되지 않았습니다.");n=new o.OpenAIEmbeddings({openAIApiKey:process.env.OPENAI_API_KEY,modelName:"text-embedding-3-small",batchSize:100})}return n}async function i(e){try{console.log(`${e.length}개 텍스트에 대한 임베딩 생성 시작`);let t=a(),r=await t.embedDocuments(e);return console.log(`임베딩 생성 완료: ${r.length}개 벡터`),r}catch(e){throw console.error("임베딩 생성 오류:",e),Error(`임베딩 생성에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`)}}async function l(e){try{let t=a();return await t.embedQuery(e)}catch(e){throw console.error("단일 임베딩 생성 오류:",e),Error(`임베딩 생성에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`)}}async function c(e,t=10,r=.7){try{let o=(0,s.B$)(),{data:n,error:a}=await o.from("document_chunks").select("chunk_text, metadata, embedding").not("embedding","is",null);if(a)return console.error("청크 조회 오류:",a),[];if(!n||0===n.length)return console.log("임베딩된 청크가 없습니다."),[];let i=n.map(t=>{if(!t.embedding||!Array.isArray(t.embedding))return{...t,similarity:0};let r=function(e,t){if(e.length!==t.length)throw Error("벡터 차원이 일치하지 않습니다.");let r=0,o=0,s=0;for(let n=0;n<e.length;n++)r+=e[n]*t[n],o+=e[n]*e[n],s+=t[n]*t[n];return 0===o||0===s?0:r/(Math.sqrt(o)*Math.sqrt(s))}(e,t.embedding);return{...t,similarity:r}}).filter(e=>e.similarity>=r).sort((e,t)=>t.similarity-e.similarity).slice(0,t);return console.log(`벡터 검색 결과: ${i.length}개 (임계값: ${r})`),i}catch(e){return console.error("벡터 검색 오류:",e),[]}}async function u(e,t){try{let r=(0,s.B$)(),o=Math.ceil(e.length/50);console.log(`${e.length}개 청크를 ${o}개 배치로 처리`);for(let s=0;s<e.length;s+=50){let n=e.slice(s,s+50),a=Math.floor(s/50)+1;console.log(`배치 ${a}/${o} 처리 중... (${n.length}개 청크)`);try{let e=n.map(e=>e.text),s=await i(e),l=n.map((e,r)=>({document_id:t,chunk_text:e.text,chunk_index:e.chunkIndex,metadata:e.metadata,embedding:s[r]})),{error:c}=await r.from("document_chunks").insert(l);c?console.error(`배치 ${a} 저장 오류:`,c):console.log(`배치 ${a} 저장 완료`),a<o&&await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`배치 ${a} 처리 오류:`,e)}}console.log("모든 청크 임베딩 처리 완료")}catch(e){throw console.error("청크 임베딩 처리 오류:",e),e}}},8234:(e,t,r)=>{r.d(t,{B$:()=>s});var o=r(7385);function s(){let e="https://puajxghokhribumtxrby.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t){let r=[];throw e||r.push("NEXT_PUBLIC_SUPABASE_URL"),t||r.push("SUPABASE_SERVICE_ROLE_KEY"),Error(`Missing Supabase environment variables: ${r.join(", ")}`)}return(0,o.eI)(e,t)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[638,117,51],()=>r(6083));module.exports=o})();