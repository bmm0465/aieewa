"use strict";(()=>{var e={};e.id=487,e.ids=[487],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},1085:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>P,originalPathname:()=>v,patchFetch:()=>k,requestAsyncStorage:()=>_,routeModule:()=>x,serverHooks:()=>w,staticGenerationAsyncStorage:()=>S,staticGenerationBailout:()=>E});var o={};r.r(o),r.d(o,{POST:()=>g,dynamic:()=>f,maxDuration:()=>h,runtime:()=>m});var n=r(5419),a=r(9108),s=r(9678),i=r(8070),u=r(3292),l=r(1017),c=r(7147),p=r(8234);let d=r(8051),m="nodejs",h=60,f="force-dynamic";async function g(e){try{console.log("문서 업로드 요청 시작");let t=(await e.formData()).get("file");if(!t)return i.Z.json({error:"파일이 필요합니다."},{status:400});if("application/pdf"!==t.type)return i.Z.json({error:"PDF 파일만 업로드할 수 있습니다."},{status:400});if(t.size>10485760)return i.Z.json({error:"파일 크기는 10MB를 초과할 수 없습니다."},{status:400});console.log("파일 업로드:",t.name,t.size,"bytes");let r=(0,l.join)(process.cwd(),"uploads");(0,c.existsSync)(r)||await (0,u.mkdir)(r,{recursive:!0});let o=await t.arrayBuffer(),n=Buffer.from(o),a=(0,l.join)(r,`${Date.now()}-${t.name}`);await (0,u.writeFile)(a,n),console.log("PDF 파싱 시작");let s=(await d(n)).text;if(!s||0===s.trim().length)return i.Z.json({error:"PDF에서 텍스트를 추출할 수 없습니다."},{status:400});console.log("PDF 텍스트 길이:",s.length);let m=function(e,t=1e3,r=200){let o=[],n=0;for(;n<e.length;){let a=Math.min(n+t,e.length),s=e.slice(n,a);if(a<e.length){let e=s.lastIndexOf("."),r=Math.max(e,s.lastIndexOf("\n"));r>n+.5*t&&(s=s.slice(0,r+1))}if(o.push(s.trim()),(n+=s.length-r)>=e.length)break;s.length<=r&&(n+=t)}return o.filter(e=>e.length>0)}(s,1e3,200);console.log("텍스트 청크 개수:",m.length),console.log("텍스트 청크 처리 시작");let h=[];for(let e=0;e<Math.min(m.length,10);e++)try{h.push({text:m[e],metadata:{source:`upload/${t.name}`,chunkIndex:e,uploadTime:new Date().toISOString(),isDefault:!1}})}catch(t){console.error(`청크 ${e} 임베딩 실패:`,t)}console.log("임베딩 생성 완료:",h.length);try{let e=(0,p.B$)(),{data:r,error:o}=await e.from("documents").insert({filename:`upload/${t.name}`,file_size:t.size,text_content:s.substring(0,1e4),chunk_count:m.length,upload_time:new Date().toISOString()}).select().single();if(o)console.error("문서 저장 오류:",o);else{for(let t of(console.log("문서 저장 성공:",r.id),h))await e.from("document_chunks").insert({document_id:r.id,chunk_text:t.text,chunk_index:t.metadata.chunkIndex,metadata:t.metadata});console.log("청크 저장 완료")}}catch(e){console.warn("데이터베이스 저장 실패, 메모리에만 보관:",e)}return i.Z.json({success:!0,message:"문서가 성공적으로 업로드되고 처리되었습니다.",filename:t.name,textLength:s.length,chunkCount:m.length,processedChunks:h.length})}catch(e){return console.error("문서 업로드 오류:",e),i.Z.json({error:"문서 업로드에 실패했습니다."},{status:500})}}let x=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/upload-document/route",pathname:"/api/upload-document",filename:"route",bundlePath:"app/api/upload-document/route"},resolvedPagePath:"C:\\Users\\bmm04\\Dev\\aieewa\\app\\api\\upload-document\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:_,staticGenerationAsyncStorage:S,serverHooks:w,headerHooks:P,staticGenerationBailout:E}=x,v="/api/upload-document/route";function k(){return(0,s.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:S})}},8234:(e,t,r)=>{r.d(t,{B$:()=>n});var o=r(7385);function n(){let e=process.env.NEXT_PUBLIC_SUPABASE_URL,t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t){let r=[];throw e||r.push("NEXT_PUBLIC_SUPABASE_URL"),t||r.push("SUPABASE_SERVICE_ROLE_KEY"),Error(`Missing Supabase environment variables: ${r.join(", ")}`)}return(0,o.eI)(e,t)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[638,117,51],()=>r(1085));module.exports=o})();