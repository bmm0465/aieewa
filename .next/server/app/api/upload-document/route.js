"use strict";(()=>{var e={};e.id=487,e.ids=[487],e.modules={8775:e=>{e.exports=require("@langchain/openai")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7147:e=>{e.exports=require("fs")},3292:e=>{e.exports=require("fs/promises")},3685:e=>{e.exports=require("http")},5687:e=>{e.exports=require("https")},1017:e=>{e.exports=require("path")},5477:e=>{e.exports=require("punycode")},2781:e=>{e.exports=require("stream")},7310:e=>{e.exports=require("url")},9796:e=>{e.exports=require("zlib")},325:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>$,originalPathname:()=>P,patchFetch:()=>A,requestAsyncStorage:()=>w,routeModule:()=>y,serverHooks:()=>_,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>b});var o={};r.r(o),r.d(o,{POST:()=>x,dynamic:()=>f,maxDuration:()=>g,runtime:()=>p});var n=r(5419),a=r(9108),s=r(9678),i=r(8070),l=r(3292),u=r(1017),c=r(7147),d=r(8234),h=r(7399);let m=r(8051),p="nodejs",g=60,f="force-dynamic";async function x(e){try{console.log("문서 업로드 요청 시작");let t=(await e.formData()).get("file");if(!t)return i.Z.json({error:"파일이 필요합니다."},{status:400});if("application/pdf"!==t.type)return i.Z.json({error:"PDF 파일만 업로드할 수 있습니다."},{status:400});if(t.size>4194304)return i.Z.json({error:`파일 크기는 4MB를 초과할 수 없습니다.`},{status:400});console.log("파일 업로드:",t.name,t.size,"bytes");let r=(0,u.join)(process.cwd(),"uploads");(0,c.existsSync)(r)||await (0,l.mkdir)(r,{recursive:!0});let o=await t.arrayBuffer(),n=Buffer.from(o),a=(0,u.join)(r,`${Date.now()}-${t.name}`);await (0,l.writeFile)(a,n),console.log("PDF 파싱 시작");let s=(await m(n)).text;if(!s||0===s.trim().length)return i.Z.json({error:"PDF에서 텍스트를 추출할 수 없습니다."},{status:400});console.log("PDF 텍스트 길이:",s.length);let p=function(e,t=1e3,r=200){let o=[],n=0;for(;n<e.length;){let a=Math.min(n+t,e.length),s=e.slice(n,a);if(a<e.length){let e=s.lastIndexOf("."),r=Math.max(e,s.lastIndexOf("\n"));r>n+.5*t&&(s=s.slice(0,r+1))}if(o.push(s.trim()),(n+=s.length-r)>=e.length)break;s.length<=r&&(n+=t)}return o.filter(e=>e.length>0)}(s,1e3,200);console.log("텍스트 청크 개수:",p.length),console.log("텍스트 청크 처리 시작");let g=[];for(let e=0;e<p.length;e++)try{g.push({text:p[e],metadata:{source:`upload/${t.name}`,chunkIndex:e,uploadTime:new Date().toISOString(),isDefault:!1}})}catch(t){console.error(`청크 ${e} 임베딩 실패:`,t)}console.log("임베딩 생성 완료:",g.length);try{let e=(0,d.B$)(),{data:r,error:o}=await e.from("documents").insert({filename:`upload/${t.name}`,file_size:t.size,text_content:s.substring(0,1e4),chunk_count:p.length,upload_time:new Date().toISOString()}).select().single();if(o)console.error("문서 저장 오류:",o);else{console.log("문서 저장 성공:",r.id);let e=g.map(e=>({text:e.text,metadata:e.metadata,chunkIndex:e.metadata.chunkIndex}));await (0,h.Hy)(e,r.id),console.log("청크 저장 완료")}}catch(e){console.warn("데이터베이스 저장 실패, 메모리에만 보관:",e)}return i.Z.json({success:!0,message:"문서가 성공적으로 업로드되고 처리되었습니다.",filename:t.name,textLength:s.length,chunkCount:p.length,processedChunks:g.length})}catch(e){return console.error("문서 업로드 오류:",e),i.Z.json({error:"문서 업로드에 실패했습니다."},{status:500})}}let y=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/upload-document/route",pathname:"/api/upload-document",filename:"route",bundlePath:"app/api/upload-document/route"},resolvedPagePath:"C:\\Users\\김민제\\Documents\\Dev\\aieewa\\app\\api\\upload-document\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:w,staticGenerationAsyncStorage:E,serverHooks:_,headerHooks:$,staticGenerationBailout:b}=y,P="/api/upload-document/route";function A(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:E})}},7399:(e,t,r)=>{r.d(t,{Hy:()=>c,eB:()=>l,yD:()=>u});var o=r(8775),n=r(8234);let a=null;function s(){if(!a){if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY 환경 변수가 설정되지 않았습니다.");a=new o.OpenAIEmbeddings({openAIApiKey:process.env.OPENAI_API_KEY,modelName:"text-embedding-3-small",batchSize:100})}return a}async function i(e){try{console.log(`${e.length}개 텍스트에 대한 임베딩 생성 시작`);let t=s(),r=await t.embedDocuments(e);return console.log(`임베딩 생성 완료: ${r.length}개 벡터`),r}catch(e){throw console.error("임베딩 생성 오류:",e),Error(`임베딩 생성에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`)}}async function l(e){try{let t=s();return await t.embedQuery(e)}catch(e){throw console.error("단일 임베딩 생성 오류:",e),Error(`임베딩 생성에 실패했습니다: ${e instanceof Error?e.message:"알 수 없는 오류"}`)}}async function u(e,t=10,r=.7){try{let o=(0,n.B$)(),{data:a,error:s}=await o.from("document_chunks").select("chunk_text, metadata, embedding").not("embedding","is",null);if(s)return console.error("청크 조회 오류:",s),[];if(!a||0===a.length)return console.log("임베딩된 청크가 없습니다."),[];let i=a.map(t=>{if(!t.embedding||!Array.isArray(t.embedding))return{...t,similarity:0};let r=function(e,t){if(e.length!==t.length)throw Error("벡터 차원이 일치하지 않습니다.");let r=0,o=0,n=0;for(let a=0;a<e.length;a++)r+=e[a]*t[a],o+=e[a]*e[a],n+=t[a]*t[a];return 0===o||0===n?0:r/(Math.sqrt(o)*Math.sqrt(n))}(e,t.embedding);return{...t,similarity:r}}).filter(e=>e.similarity>=r).sort((e,t)=>t.similarity-e.similarity).slice(0,t);return console.log(`벡터 검색 결과: ${i.length}개 (임계값: ${r})`),i}catch(e){return console.error("벡터 검색 오류:",e),[]}}async function c(e,t){try{let r=(0,n.B$)(),o=Math.ceil(e.length/50);console.log(`${e.length}개 청크를 ${o}개 배치로 처리`);for(let n=0;n<e.length;n+=50){let a=e.slice(n,n+50),s=Math.floor(n/50)+1;console.log(`배치 ${s}/${o} 처리 중... (${a.length}개 청크)`);try{let e=a.map(e=>e.text),n=await i(e),l=a.map((e,r)=>({document_id:t,chunk_text:e.text,chunk_index:e.chunkIndex,metadata:e.metadata,embedding:n[r]})),{error:u}=await r.from("document_chunks").insert(l);u?console.error(`배치 ${s} 저장 오류:`,u):console.log(`배치 ${s} 저장 완료`),s<o&&await new Promise(e=>setTimeout(e,1e3))}catch(e){console.error(`배치 ${s} 처리 오류:`,e)}}console.log("모든 청크 임베딩 처리 완료")}catch(e){throw console.error("청크 임베딩 처리 오류:",e),e}}},8234:(e,t,r)=>{r.d(t,{B$:()=>n});var o=r(7385);function n(){let e="https://puajxghokhribumtxrby.supabase.co",t=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!t){let r=[];throw e||r.push("NEXT_PUBLIC_SUPABASE_URL"),t||r.push("SUPABASE_SERVICE_ROLE_KEY"),Error(`Missing Supabase environment variables: ${r.join(", ")}`)}return(0,o.eI)(e,t)}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[638,117,51],()=>r(325));module.exports=o})();